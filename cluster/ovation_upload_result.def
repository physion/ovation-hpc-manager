BootStrap: docker
From: ubuntu:16.04
%post
	echo "Installing extra packages..."
    apt-get -y update
    apt-get -y install python3-pip
    apt-get update
    pip3 install ovation==1.22.0
    pip3 install google-cloud-pubsub==0.29.0
    mkdir /local
    chmod 777 /local
%runscript

    if [ -s /local/s_aws_err_"$3".out ]
    then
        python3 /local/ovation/hpc-manager/hpc_manager/ovation_delivery.py error -j "$3" -a "$2" -e "$(< /local/s_aws_err_"$3".out)" || echo "Error to send the message to $PUBSUB_FAILURES_TOPIC"
    else
        python3 /local/ovation/hpc-manager/hpc_manager/ovation_delivery.py success -j "$3" -a "$2" || echo "Error to send the message to $PUBSUB_SUCCESSES_TOPIC"
    fi

    python3 -m ovation.cli -t "$1" add-outputs "$2" /local/ovation/data/$2/outputs/*
