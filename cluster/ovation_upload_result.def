BootStrap: docker
From: ubuntu:16.04
%post
	echo "Installing extra packages..."
    apt-get -y update
    apt-get -y install python3-pip
    apt-get update
    mkdir /local
    chmod 777 /local
%environment
    GOOGLE_APPLICATION_CREDENTIALS="/local/ovation/ovation_key.json"
    PUBSUB_FAILURES_TOPIC="compute-failures-development"
    PUBSUB_SUCCESSES_TOPIC="compute-successes-development"
    GOOGLE_CLOUD_PROJECT_ID="ovation-development"
%runscript
    echo "Installing requirements"
    pip3 install -r /local/ovation/hpc-manager/requirements.txt
    echo "Sending response"
    if [ -e /local/s_aws_err_"$3".out ]
    then
        python3 /local/ovation/hpc-manager/hpc_manager/ovation_delivery.py error -j "$3" -a "$2" -e "$(< /local/s_aws_err_"$3".out)"
        echo "$PUBSUB_FAILURES_TOPIC"
    else
        python3 /local/ovation/hpc-manager/hpc_manager/ovation_delivery.py success -j "$3" -a "$2"
        echo "$PUBSUB_SUCCESSES_TOPIC"
    fi

    python3 -m ovation.cli -t "$1" add-outputs "$2" /local/ovation/data/$2/outputs/*
