#!/bin/bash
#SBATCH --job-name=s_aws
#SBATCH --output=s_aws_out_%j.out
#SBATCH --workdir=/local
#SBATCH --partition=us-east-1
#SBATCH --ntasks=1
#SBATCH --time=10:00
#SBATCH --mail-user=example@alphacruncher.com
#SBATCH --mail-type=ALL

module load shared
module load slurm/17.02.2
module load singularity/2.4

API_TOKEN=$1
ACTIVITY_UUID=$2
SECOND_JOB=$3
USER_IMAGE=$4
FIRST_JOB=$5
OVATION_CLI_ARGS=$6

echo "test upload result"
chmod 777 /local/s_aws_out_"$SECOND_JOB".out

export GOOGLE_APPLICATION_CREDENTIALS="/local/ovation/ovation_credentials.json"
export PUBSUB_FAILURES_TOPIC="compute-failures-development"
export PUBSUB_SUCCESSES_TOPIC="compute-successes-development"
export GOOGLE_CLOUD_PROJECT_ID="ovation-io"

cp /local/s_aws_out_"$SECOND_JOB".out /local/ovation/data/"$ACTIVITY_UUID"/outputs/s_aws_out_"$SECOND_JOB".out


export SINGULARITY_BINDPATH="/local/:/local"
echo "run container"
/cm/shared/sing-images/ovation/ovation_upload_result.img "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl9pZCI6NTEsInN1YiI6Imdvb2dsZS1vYXV0aDJ8MTAzNTI3ODQ2Njc4NTI4ODI1NDcxIiwic2NvcGUiOiJyZWFkOmdsb2JhbCB3cml0ZTpnbG9iYWwiLCJuYW1lIjoiVGFtYXJhIE9ydGl6In0.dBzOO5zvO_B3GQLYm-0x7HYVRYqoPpxlBbjJiMEwul4" "20f5c7d5-4fad-4d7c-8fa1-d546ceaad46a" "1011" "--development"
echo "exit container"

rm -rf /local/ovation/data/$ACTIVITY_UUID/
rm /cm/shared/sing-images/ovation/$FIRST_JOB/$USER_IMAGE
-u
"tamara@ovation.io"
-t
"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl9pZCI6NTEsInN1YiI6Imdvb2dsZS1vYXV0aDJ8MTAzNTI3ODQ2Njc4NTI4ODI1NDcxIiwic2NvcGUiOiJyZWFkOmdsb2JhbCB3cml0ZTpnbG9iYWwiLCJuYW1lIjoiVGFtYXJhIE9ydGl6In0.dBzOO5zvO_B3GQLYm-0x7HYVRYqoPpxlBbjJiMEwul4"
--development
hpc-run
--activity_id
"20f5c7d5-4fad-4d7c-8fa1-d546ceaad46a"
--image
"test.img"
--url
"https://hpc-development.ovation.io/hpc_run"
